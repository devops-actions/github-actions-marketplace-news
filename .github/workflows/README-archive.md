# Archive Old Posts Workflow

This workflow automatically archives old blog posts to reduce the size of GitHub Pages deployments.

## Problem Statement

Over time, this repository accumulates thousands of blog posts, causing the `public/` directory (generated by Hugo) to grow very large. This leads to:
- Large artifact uploads during GitHub Actions workflow runs
- Slower deployment times
- Potential warnings or errors from GitHub Pages about file size limits

## Solution

The `archive-old-posts.yaml` workflow periodically moves old posts to an archive directory:
- **Default behavior**: Archives posts older than 12 months
- **Frequency**: Runs monthly on the 1st at 2am UTC
- **Manual trigger**: Can be run manually with custom retention period

## How It Works

1. The workflow runs the `scripts/archive-old-posts.sh` script
2. Posts older than the retention period are moved from `content/posts/` to `content/archive/`
3. The archive directory is excluded from Hugo builds (via `hugo.toml`)
4. Changes are committed and pushed to the main branch
5. The next deployment will be smaller and faster

## Configuration

### Retention Period

The default retention period is **12 months**. You can customize this:

**Via workflow dispatch:**
1. Go to Actions tab in GitHub
2. Select "Archive Old Posts" workflow
3. Click "Run workflow"
4. Enter custom number of months
5. Click "Run workflow" button

**In the workflow file:**
Edit `.github/workflows/archive-old-posts.yaml` and change the default value:
```yaml
archive_months:
  description: 'Number of months to keep (older posts will be archived)'
  default: '12'  # Change this value
```

### Schedule

The workflow runs monthly by default. To change the schedule, edit the cron expression:
```yaml
schedule:
  - cron: '0 2 1 * *'  # Monthly on the 1st at 2am UTC
```

Examples:
- Weekly: `0 2 * * 0` (Sundays at 2am)
- Quarterly: `0 2 1 */3 *` (Every 3 months)
- Bi-weekly: `0 2 1,15 * *` (1st and 15th of each month)

## Benefits

- **Reduced deployment size**: Smaller artifacts mean faster uploads and deployments
- **Better performance**: Hugo builds faster with fewer files to process
- **Automated**: Runs automatically without manual intervention
- **Reversible**: Archived posts are preserved and can be restored if needed
- **Transparent**: Git history shows exactly what was archived and when

## Archive Location

Archived posts are stored in:
```
content/archive/
├── 2023/
│   ├── 07/
│   ├── 08/
│   └── ...
└── 2024/
    ├── 01/
    └── ...
```

This directory:
- Is excluded from Hugo builds (via `ignoreFiles` in `hugo.toml`)
- Is excluded from version control (via `.gitignore`)
- Preserves the original directory structure
- Can be manually reviewed or restored if needed

## Monitoring

The workflow provides detailed output:
- Lists each year/month archived
- Shows count of posts archived per month
- Displays before/after statistics
- Creates a job summary in GitHub Actions UI

## Manual Restoration

If you need to restore archived posts:

1. Move posts from `content/archive/` back to `content/posts/`:
   ```bash
   # Restore a specific month
   mv content/archive/2023/08 content/posts/2023/
   
   # Restore an entire year
   mv content/archive/2023/* content/posts/2023/
   ```

2. Commit and push the changes:
   ```bash
   git add content/posts/
   git commit -m "Restore archived posts from 2023/08"
   git push
   ```

## Troubleshooting

### No posts are being archived

Check that:
- Posts exist that are older than the retention period
- The cutoff date calculation is correct for your timezone
- The post directory structure follows `YYYY/MM/` format

### Build errors after archiving

If Hugo fails to build after archiving:
1. Check the Hugo build logs for specific errors
2. The `build-hugo-with-recovery.sh` script will automatically handle most errors
3. Archived posts may have had syntax errors that are now resolved

### Want to change retention period

Simply run the workflow manually with a different value:
- Larger value (e.g., 18 months): Fewer posts archived, larger deployments
- Smaller value (e.g., 6 months): More posts archived, smaller deployments

## Related Files

- **Workflow**: `.github/workflows/archive-old-posts.yaml`
- **Script**: `scripts/archive-old-posts.sh`
- **Hugo Config**: `hugo.toml` (contains `ignoreFiles` configuration)
- **Git Ignore**: `.gitignore` (excludes archive directory)
- **Documentation**: `scripts/README.md` (script documentation)
