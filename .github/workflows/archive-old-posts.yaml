# Workflow to periodically archive old blog posts
# This reduces the size of deployments by moving older content to an archive
name: Archive Old Posts

on:
  # Run monthly on the 1st at 2am UTC
  schedule:
    - cron: '0 2 1 * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      archive_months:
        description: 'Number of months to keep (older posts will be archived)'
        required: false
        default: '12'
        type: string

permissions: {}

jobs:
  archive:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # Full history for proper commit
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run archive script
        id: archive
        run: |
          # Validate and set archive months from input or default to 12
          MONTHS="${{ github.event.inputs.archive_months || '12' }}"
          
          # Validate it's a positive integer
          if ! [[ "$MONTHS" =~ ^[0-9]+$ ]] || [ "$MONTHS" -lt 1 ]; then
            echo "❌ Error: archive_months must be a positive integer"
            exit 1
          fi
          
          export ARCHIVE_MONTHS="$MONTHS"
          
          echo "Running archive script with ARCHIVE_MONTHS=$ARCHIVE_MONTHS"
          ./scripts/archive-old-posts.sh | tee archive-output.log
          
          # Check if any files were removed
          if git status --porcelain | grep -qE "^ D content/posts"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Extract removed count with a default value if not found
            removed_count=$(grep -oP "Total posts removed: \K[0-9]+" archive-output.log || echo "unknown")
            echo "removed_count=$removed_count" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "removed_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.archive.outputs.has_changes == 'true'
        run: |
          # Stage the removed files
          git add content/posts/
          
          # Get removed count
          removed_count="${{ steps.archive.outputs.removed_count }}"
          
          # Create commit message
          git commit -m "Archive old posts: removed $removed_count posts" \
                     -m "This automated commit removes blog posts older than ${{ github.event.inputs.archive_months || '12' }} months to reduce deployment size and improve build performance." \
                     -m "Removed content can be restored from git history if needed."
          
          # Push to main branch
          git push origin main

      - name: Summary
        if: always()
        run: |
          echo "## Archive Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.archive.outputs.has_changes }}" == "true" ]; then
            echo "✅ Posts were removed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Removed: ${{ steps.archive.outputs.removed_count }} posts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Archive Details" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat archive-output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No posts needed removal. All posts are within the retention window." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send Slack notification on failure
        # Using rajbos-actions fork which is maintained by the repository owner
        uses: rajbos-actions/slack@ed1309ab9862e57e9e583e51c7889486b9a00b0f # v2.0.0
        with: 
          status: ${{ job.status }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: failure()
